\chapter[The Maximal Abelian Subgroup Class Equation]{The Maximal Abelian Subgroup Class Equation}\label{Ch6_MaximalAbelianSubgroupClassEquation}
% \chaptermark{The Class Equation}

\section[A finite subgroup of $\SL_2(F)$]{A Finite Subgroup of $\pmb{L}$}

We now return to the realm of finite groups and consider $G$ to be an arbitrary finite subgroup of $\SL_2(F)$. We will still continue to use $Z$ to denote the centre of $\SL_2(F)$, and will use $Z(G)$ whenever we refer to the centre of $G$. \\
\\
Observe that if $Z$ is not contained in $G$, then $Z$ must contain a non-identity element, thus $|Z| = 2$ and $p \neq 2$ by Lemma \ref{6.2}. Recall that $\SL_2(F)$ has a unique element of order 2 by Lemma \ref{6.2b}, $- I_L$, which is not in $G$, therefore $G$ has no element of order 2. \\
\\
By Cauchy's Theorem, which says that if a prime $p$ divides the order of a finite group, then the group contains an element of order $p$, we deduce that 2 does not divide the order of $G$. \\
\\
This means that $|G|$ and $|Z|$ are relatively prime, so $G \cap Z = \{ I_L \}$ and we can use Corollary \ref{directproductZ} to show that $GZ \cong G \times Z$. This shows that regardless of whether $G$ contains $Z$ or not, its structure is uniquely determined by $GZ$, so it suffices to only consider the case when $Z \subset G$. 

\section{Maximal Abelian Subgroups}

\begin{definition}[Maximal Abelian Subgroup]
\label{IsMaximalAbelian}
\lean{IsMaximalAbelian}
\leanok
Let $H$ and $J$ be subgroups of a group $G$ where $H$ is abelian. $H$ is called \textbf{maximal abelian} if $J$ is not abelian whenever $H \subsetneq J$.
\end{definition}

\begin{remark}
The definition was stated in positive form:

A subgroup $H$ is said to be a maximal abelian subgroup of $G$ if for every $J$ subgroup of $G$ satisfying $H \le J$ we have that $J \le H$. Which overall implies $H = J$ by antisymmetry of the preorder.

In Lean this statement looks like the following:

\begin{verbatim}
  def IsMaximalAbelian {L : Type*} [Group L] (G : Subgroup L) : Prop := Maximal (IsCommutative) G
\end{verbatim}

  where the definition of \texttt{Maximal} in mathlib implicitly recognises the existence of a $\le$ operator (a more primitive notion of a partial order) and is:

  \begin{verbatim}
    def Maximal (P : α → Prop) (x : α) : Prop := P x ∧ ∀ ⦃y⦄, P y → x ≤ y → y ≤ x
  \end{verbatim}

  Which informally means that an object $M$ that satisfies a property is maximal if any other object $K$ that also satisfies the property and is related to $M$ by $M \le K$ then in fact we must have the symmetric relation $K \le M$.

  When $\le := \subseteq$ then this is the natural notion of maximal.
\end{remark}


\begin{definition}[Elementary Abelian]
\label{IsElementaryAbelian}
\lean{IsElementaryAbelian}
\leanok
A group $G$ is said to be \textbf{elementary abelian} if it is abelian and every non-trivial element has order $p$, where $p$ is prime.
\end{definition}

\begin{remark}
  In Lean we define the notion of a subgroup of $H$ of $G$ being elementary abelian the following way:
  
  \begin{verbatim}
  def IsElementaryAbelian {G : Type*} [Group G] (p : ℕ) (H : Subgroup G) : Prop :=
  IsCommutative H ∧ ∀ h : H, h ≠ 1 → orderOf h = p
  \end{verbatim}
\end{remark}

\begin{definition}
\label{MaximalAbelianSubgroupsOf}
\uses{IsMaximalAbelian}
\lean{MaximalAbelianSubgroupsOf}
\leanok
Let $\mathfrak{M}$ denote the set of all maximal abelian subgroups of $G$.
\end{definition}

\begin{remark}
  When a set/object with some additional structure has been defined informally, when one wants to formalise results about the object it is often the case a decision has to be made
  about whether the set is defined in Lean as a set or whether it is defined as its own type. In this case, I have opted to define it as a set but later on when using quotients we shall see an example
  of how it is beneficial to define an object as a type/subtype in its own right.
\end{remark}

\vspace{3mm}

Maximal abelian subgroups play an important role in determining the structure of $G$. In particular, every element in $G$ must be contained in some maximal abelian subgroup, since every element commutes at least with itself and $Z$. This will allow us to decompose $G$ into the conjugacy classes of these maximal abelian subgroups. Note also that unless $G=Z$, $Z$ is not a maximal abelian subgroup, because for each $x \in G \! \setminus \! Z$, $\langle Z,x \rangle$ is clearly a larger abelian subgroup than $Z$. \\
\\
We will shortly prove an important theorem regarding the maximal abelian subgroups of $G$, but in order to do so we require the following two lemmas. \\

\begin{lemma}
  \label{IsElementaryAbelian.dvd_card}
  \lean{IsElementaryAbelian.dvd_card}
  \leanok
If $G$ is a finite group of order $p^m$ where $p$ is prime and $m > 0$, then $p$ divides $|Z(G)|$. 
\end{lemma}

\begin{proof}
Let $C(x)$ be the set of elements of $G$ which are conjugate in $G$ to $x$, we call this the conjugacy class of $x$. Bhattacharya shows that the set of all conjugacy classes form a partition of $G$ \cite[p.112]{bhattacharya}. Now consider the following rearranged class equation of $G$, where $S$ is a subset of $G$ containing exactly one element from each conjugacy class not contained in $Z(G)$. 
 
\begin{equation} \label{cen2}
|G| - \sum_{x \in S} [G:N_G(x)] = |Z(G)|.
\end{equation}

Since $|G| = p^m$, each subgroup of $G$ is of order $p^k$ for some $k \leq m$. In particular each $N_G(x)$ has order $p^k$ and is strictly contained in $G$ since $x \not \in Z(G)$ by assumption. Thus each $[G:N_G(x)] > 1$, and are therefore divisible by $p$. Since $p$ divides the left hand side of (\ref{cen2}), it must also divide the right, thus $p$ divides $|Z(G)|$. 

\end{proof}



\begin{lemma}
  \label{coprime_card_fin_subgroup_of_inj_hom_group_iso_units}
  \lean{coprime_card_fin_subgroup_of_inj_hom_group_iso_units}
  \leanok
Every finite subgroup of a multiplicative group of a field is cyclic.
\end{lemma}
%PROOF AND DEPENDENCIES

\begin{proof} 
  See \cite[p.41]{suzuki}.
\end{proof}

\begin{theorem}
  \label{MaximalAbelianSubgroup.centralizer_meet_G_in_MaximalAbelianSubgroups_of_noncentral}
  \uses{IsCommutative_centralizer_of_not_mem_center, MaximalAbelianSubgroupsOf}
  \lean{MaximalAbelianSubgroup.centralizer_meet_G_in_MaximalAbelianSubgroups_of_noncentral}
  \leanok 
  Let $G$ be an arbitrary finite subgroup of $\SL_2(F)$ containing $Z$. \\
If $x \in G \! \setminus \! Z$ then we have $C_G(x) \in \mathfrak{M}$. \vspace{3mm} \\
\end{theorem}
\begin{proof}
  Let $x$ be chosen arbitrarily from $G \! \setminus \! Z$. Then by Corollary \ref{6.5}, $C_{\SL_2(F)}(x)$ is abelian. By definition, $C_G(x) = C_{\SL_2(F)}(x) \cap G$, and using the elementary fact that the intersection of two subgroups is itself a subgroup, we have $C_G(x) < C_{\SL_2(F)}(x)$. Now since every subgroup of an abelian group is abelian, $C_G(x)$ is also abelian. \\
  \\
  Now let $J$ be a maximal abelian subgroup of $G$ containing $C_G(x)$. Since $J$ is abelian and $x \in C_G(x) \subset J$, we have $jx=xj$, $\forall j \in J$, thus $J \subset C_G(x)$. Therefore $J=C_G(x)$ and $C_G(x) \in \mathfrak{M}$. \\
\end{proof}

Before we continue proving properties about Maximal Abelian Subgroups we first need to understand how commutative subgroups interact with other subgroups. 
We now list a few results about commutative subgroups and their interaction with other subgroups:

\begin{remark}
\label{IsCommutative_of_IsCommutative_subgroupOf}
\lean{IsCommutative_of_IsCommutative_subgroupOf}
\leanok
Let $H, K$ be two subgroups of a group $G$ then $H \sqcap K = H \cap K$ is commutative if $H \sqcap K$ regarded as a subgroup of $K$ is commutative.
\end{remark}

\begin{remark}
  The remark above \ref{IsCommutative_of_IsCommutative_subgroupOf} probably seems ridiculous, but Lean genuinely understands both objects as belonging to completely different types and 
  this result is necessary to be able to jump between the corresponding contexts.
\end{remark}

\begin{definition}
  \label{center_mul}
  \lean{center_mul}
  \leanok
  Let $H$ be a subgroup of a group $G$ then the pointwise set product $Z(G) H$ is a subgroup of $G$
\end{definition}
\begin{proof}
\begin{enumerate}
  \item \texttt{one_mem'}: Both $Z(G)$ and $H$ are subgroups of $G$ so they contain the identity element, thus $1 \cdot 1 \in Z(G) H$.
  \item \texttt{mul_mem'}: Let $z_1 h_1, z_2 h_2 \in Z(G) H$ then $z_1h_1z_2h_2 = z_1z_2 h_1h_2 \in Z(G) H$ as $z_i$ is in the center.
  \item \texttt{inv_mem'}: Let $zh \in Z(G) H$ then $z^{-1} h^{-1} \in Z(G) H$ and $z h z^{-1} h^{-1} = zz^{-1}h h^{-1} = 1$.

\end{enumerate}
\end{proof}


\begin{lemma}
  \label{center_mul_subset_center_mul}
  \uses{center_mul}
  \lean{center_mul_subset_center_mul}
  \leanok
\end{lemma}

\begin{lemma}[ The join of a commutative subgroup with the center of a group is commutative]
  \label{IsComm_of_center_join_IsComm}
  \uses{center_mul_subset_center_mul, center_mul}
  \lean{IsComm_of_center_join_IsComm}
  \leanok

  Let $H$ be a commutative subgroup of $G$ then the subgroup $Z(G) \sqcup H$  is a commutative subgroup of $G$.
\end{lemma}
\begin{proof}
  Let $x, y \in Z(G) \sqcup H$ recalling that the supremum can be thought of taking the closure
  we know that if $x$ and $y$ belong to the closure then since $Z(G) H$ is a subgroup of $G$ and $Z(G) \sqcup H \subseteq Z(G) H$
  we know that $x, y \in Z(G) H$ and thus there exist $z_1 h_1 = x$ and $z_2 h_2 = y$. Therefore, we can now show that $x$ and $y$ commute:

  \begin{align*}
  x y &= z_1 h_1 z_2 h_2\\
  & = z_1 z_2 h_1 h_2 \tag{as $z_2$ is in the center}\\
  &= z_2 z_1 h_2 h_1 \tag{as $H$ is a commutative subgroup}\\
  &= z_2 h_2 z_1 h_1 \tag{as $z_1$ is in the center}
  \end{align*}
\end{proof}

\begin{lemma}[$Z$ is contained within any Maximal Abelian Subgroup of a subgroup containing $Z$]
  \label{MaximalAbelianSubgroup.center_le}
  \uses{IsCommutative_of_IsCommutative_subgroupOf, IsComm_of_center_join_IsComm}
  \lean{MaximalAbelianSubgroup.center_le}
  Let $H$ be a subgroup of $G$, if $Z(G) \le H$ then for any maximal abelian subgroup of $H$, $A$ we have that $Z(G) \le A$ 
  \leanok
\end{lemma}
\begin{proof}
  
\end{proof}

\begin{lemma}
\label{MaximalAbelianSubgroup.le_centralizer_of_mem}
\lean{MaximalAbelianSubgroup.le_centralizer_of_mem}
\leanok
Let $H$ be a subgroup of $G$ and let $A$ be a maximal abelian subgroup of $H$, and let $x \in A$ then $A \le C_G(x)$.
\end{lemma}

\begin{lemma}
  \label{MaximalAbelianSubgroup.not_le_of_ne}
  \lean{MaximalAbelianSubgroup.not_le_of_ne}
  \leanok
  Let $H$ be a subgroup of a group $G$ and let $A \ne B$ be maximal abelian subgroups of $H$ then $B \not\le A$.
\end{lemma}
\begin{proof}
Suppose for a contradiction that $B \le A$, then by the maximality of $B$ and because $A$ is commutative as it is maximal abelian we must have that $A \le B$.
But this shows $A = B$ by antisymmetry, a contradiction.
\end{proof}

\begin{lemma}
  \label{MaximalAbelianSubgroup.lt_cen_meet_G}
  \uses{MaximalAbelianSubgroup.not_le_of_ne, MaximalAbelianSubgroup.le_centralizer_of_mem}
  \lean{MaximalAbelianSubgroup.lt_cen_meet_G}
  \leanok
  Let $H$ be a subgroup of $G$, let $A \ne B$ be maximal abelian subgroups of $H$ and let $x \in A \cap B$ then $A < C_G(x) \sqcap H$.
\end{lemma}

\begin{theorem}
  \label{MaximalAbelianSubgroup.center_eq_meet_of_ne_MaximalAbelianSubgroups}
  \uses{MaximalAbelianSubgroup.centralizer_meet_G_in_MaximalAbelianSubgroups_of_noncentral, MaximalAbelianSubgroup.center_le, MaximalAbelianSubgroup.lt_cen_meet_G, MaximalAbelianSubgroup.le_centralizer_of_mem}
  \lean{MaximalAbelianSubgroup.center_eq_meet_of_ne_MaximalAbelianSubgroups}
For any two distinct subgroups $A$ and $B$ of $\mathfrak{M}$, we have
\begin{align*} A \cap B = Z. \end{align*}
\end{theorem}

\begin{proof}
  Consider $x \in A \cap B$. Since both $A$ and $B$ are abelian, $x$ commutes with each $a \in A$ and $b \in B$ and thus $C_G(x)$ contains both $A$ and $B$.  If $x \in G \setminus Z$, then $C_G(x) \in \mathfrak{M}$ by \ref{MaximalAbelianSubgroup.centralizer_meet_G_in_MaximalAbelianSubgroups_of_noncentral} and because $A$ and $B$ are distinct we have $A \subsetneq A \cup B \subset C_G(x)$. 
  This contradicts the fact that $A$ is maximum abelian and thus $x \in Z$. Finally, note that Z is contained in every maximal abelian subgroup, since otherwise we would have the contradiction that $\langle A, Z \rangle$ would generate a larger abelian subgroup than $A$. Hence $A \cap B = Z$. \\
\end{proof}

%---------------------------------------

\begin{lemma}
\label{MaximalAbelianSubgroup.singleton_of_cen_eq_G}
\uses{MaximalAbelianSubgroup.center_le, MaximalAbelianSubgroupsOf, IsMaximalAbelian}
\lean{MaximalAbelianSubgroup.singleton_of_cen_eq_G}
\leanok
Let $H$ be a subgroup of $G$ and suppose $H = Z(G)$ then the maximal abelian subgroups are $\mathfrak{M} = \{Z(G)\}$.
\end{lemma}
\begin{proof}
  We show that $A \in \mathfrak{M}$ if and only if $A = Z(G)$
  \begin{itemize}
    \item[$\Rightarrow$] Suppose $A$ is a maximal abelian subgroup of $H$, then by \ref{MaximalAbelianSubgroup.center_eq_meet_of_ne_MaximalAbelianSubgroup.center_le} $Z(G) \le A$. Furthermore, $A \le H = Z(G)$; which overall shows $A = Z(G)$ as required.
    \item[$\Leftarrow$] Suppose $A = Z(G)$ we now show that $A$ is a maximal abelian subgroup. 
      On the one hand, $A = Z(G)$ so it follows that $A$ is abelian.
      On the other hand, we need to show that $Z(G)$ is maximal. Let $B$ be a subgroup of $H$ that is commutative and such that $Z(G) \sqcap H \le B$, we show that it follows that $B \le Z(G) \sqcap H$. But this follows trivially as 
      $B \leq H = Z(G) \sqcap H = \top$.
  \end{itemize}
\end{proof}

\begin{lemma}
  \label{MaximalAbelianSubgroup.IsCyclic_and_card_Coprime_CharP_of_center_eq}
  \uses{MaximalAbelianSubgroup.singleton_of_cen_eq_G, SpecialSubgroups.card_Z_eq_two_of_two_ne_zero, SpecialSubgroups.IsCyclic_Z, SpecialSubgroups.card_Z_eq_one_of_two_eq_zero}
  \lean{MaximalAbelianSubgroup.IsCyclic_and_card_Coprime_CharP_of_center_eq}
  \leanok
  If $G = Z(G)$ then an element $A$ of $\mathfrak{M}$, the maximal abelian subgrups of $G$ is a cyclic group whose order is relatively prime to $p$.
\end{lemma}
\begin{proof}
  Here $G$ is the only element of $\mathfrak{M}$. If $p \neq 2$ then $|G|=2$ and $G$ is a cyclic group whose order is relatively prime to $p$. If $p=2$ then $G = I_G$ which is trivially a $S_p$-subgroup. \\
\end{proof}

\begin{remark}
  \label{mem_centralizer_self}
  \lean{mem_centralizer_self}
  \leanok
 Let $G$ be a group then centralizer of an element $x \in G$, $C_G(x)$ contains $x$. 
\end{remark}

\begin{lemma}
  \label{MaximalAbelianSubgroup.center_not_mem}
  \uses{mem_centralizer_self, MaximalAbelianSubgroup.centralizer_meet_G_in_MaximalAbelianSubgroups_of_noncentral}
  \lean{MaximalAbelianSubgroup.center_not_mem}
  \leanok
  Let $F$ be an algebraically closed field, let $G$ be a subgroup of $\SL_2(F)$ where $G \ne Z(\SL_2(F))$ then the center is not a maximal abelian subgroup of $G$, $Z(G) \notin \mathfrak{M}$.
\end{lemma}
% PROOF

\begin{lemma}
  \label{MaximalAbelianSubgroup.le_centralizer_meet}
  \uses{IsCommutative_of_IsCommutative_subgroupOf}
  \lean{MaximalAbelianSubgroup.le_centralizer_meet}
  \leanok

  Let $H$ be a subgroup of a group $G$, let $A$ be a maximal abelian subgroup of $H$, and suppose $x \in A \subseteq G$ then 
  $A \le C_{\SL_2(F)} \sqcap H$.
\end{lemma}
%PROOF

\begin{lemma}
  \label{MaximalAbelianSubgroup.eq_centralizer_meet_of_center_lt}
  \uses{MaximalAbelianSubgroup.centralizer_meet_G_in_MaximalAbelianSubgroups_of_noncentral, MaximalAbelianSubgroup.le_centralizer_meet}
  \lean{MaximalAbelianSubgroup.eq_centralizer_meet_of_center_lt}
  \leanok
  Let $F$ be an algebraically closed field, let $G$ and $A$ be a subgroup of $\SL_2(F)$ where $A$ is a maximal abelian subgroup of $G$ and $Z(\SL_2(F)) < A$ then there exists an element $x \in G \setminus Z(SL(2)) \subseteq \SL_2(F)$ such that
  $A = C_{\SL_2(F)}(x) \sqcap G = C_{G}(x)$.
\end{lemma}
%PROOF

\begin{theorem}
  \label{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_of_IsConj_d}
  \uses{SpecialSubgroups.center_SL2_eq_Z, conjugate_centralizers_of_IsConj, centralizer_d_eq_D, SpecialMatrices.d, SpecialSubgroups.D_iso_units, 
    coprime_card_fin_subgroup_of_inj_hom_group_iso_units}
  \lean{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_of_IsConj_d}
  \leanok
  Let $F$ be an algebraically closed field of characteristic $p$ and let $G$ be a finite subgroup of $\SL_2(F)$ containing $Z$, let $A$ be a subgroup of $\SL_2(F)$ which is a maximal abelian subgroup of $G$ and furthermore suppose 
  that $A = C_{\SL_2(F)}(x) \sqcap G$ where $x \in \SL_2(F) \setminus Z$ and that $x$ is conjugate to $d_\delta$ for some $\delta \in F^\times$ then $A$ is cyclic and the cardinality of $A$ is coprime to $p$.
\end{theorem}
%PROOF

To prove the statement when $x$ is conjugate to $s_\sigma$ for some $\sigma \in F$ we first need the following lemmas:

\begin{lemma}
  \label{MaximalAbelianSubgroup.centralizer_eq_conj_SZ_of_IsConj_s_or_IsConj_neg_s}
  \lean{MaximalAbelianSubgroup.centralizer_eq_conj_SZ_of_IsConj_s_or_IsConj_neg_s}
  \leanok
\end{lemma}

We need the following computations which essentially makes allowances which let us think of the complete lattice structure with the further property of
being a distributive lattice, that is, $(H \sqcup K) \sqcap L = (H \sqcap L) \sqcup (K \sqcap L)$.


\begin{lemma}
  \label{MaximalAbelianSubgroup.conj_T_join_Z_meet_G_eq_conj_T_meet_G_join_Z}
  \uses{SpecialSubgroups.center_SL2_eq_Z, SpecialSubgroups.S, SpecialSubgroups.Z}
  \lean{MaximalAbelianSubgroup.conj_T_join_Z_meet_G_eq_conj_T_meet_G_join_Z}
  \leanok

  Let $c \in \SL_2(F)$  and $G$ be a subgroup of $\SL_2(F)$ then $c(S \sqcup Z)c^{-1} \sqcap G = (cSc^{-1} \sqcap G) \sqcup Z$
\end{lemma}
% PROOF AND DEPENDENCIES

We also need the following computation:
\begin{lemma}
\label{MaximalAbelianSubgroup.conj_inv_conj_eq}
\uses{SpecialSubgroups.center_SL2_eq_Z}
\lean{MaximalAbelianSubgroup.conj_inv_conj_eq}
\leanok
Let $c \in \SL_2(F)$ and $G$ be a subgroup of $\SL_2(F)$ then 
\[
c^{-1}(c(S \sqcap G)c^{-1} \sqcup Z)c = (S \sqcap c^{-1}Gc) \sqcup Z
\]
\end{lemma}
% PROOF AND DEPENDENCIES

\begin{remark}
  \label{IsElementaryAbelian.subgroupOf}
  \lean{IsElementaryAbelian.subgroupOf}
  \leanok
  If a subgroup $H$ of a group $G$ is an elementary abelian subgroup then for any subgroup $K$ we have that $H \sqcap K$ is also an elementary abelian subgroup.
\end{remark}


\begin{lemma}
  \label{MaximalAbelianSubgroup.exists_noncenter_of_card_center_lt_card_center_Sylow}
  \uses{SpecialSubgroups.center_SL2_eq_Z, SpecialSubgroups.card_Z_eq_one_of_two_eq_zero, SpecialSubgroups.card_Z_eq_two_of_two_ne_zero, SpecialSubgroups.Z }
  \lean{MaximalAbelianSubgroup.exists_noncenter_of_card_center_lt_card_center_Sylow}
  \leanok
  Let $G$ be a finite subgroup of $\SL_2(F)$, let $S$ be a $p$-Sylow subgroup of $G$ where $p$ is the characteristic of the field $F$ and furthermore suppose $p \le |Z|$ then
  there exists a noncentral element in $S$, that is, $S \setminus Z \ne \varnothing$.
\end{lemma}
%PROOF AND DEPENDENCIES

To show the Sylowness of the subgroup we shall construct we need the following lemma:

\begin{lemma}
 \label{MaximalAbelianSubgroup.mul_center_inj}
 \uses{SpecialSubgroups.center_SL2_eq_Z}
 \lean{MaximalAbelianSubgroup.mul_center_inj}
 \leanok
 Let $S$ and $Q$ be subgroups of a group $\SL_2(F)$ where $S \le Q$ and furthermore, we have the added condition that either $I = -I$ or $-I \notin S$ and suppose $SZ = QZ$ then
 $S = Q$
\end{lemma}
%PROOF AND DEPENDENCIES

\begin{theorem}
\label{MaximalAbelianSubgroup.A_eq_Q_join_Z_of_IsConj_s_or_neg_s}
\uses{MaximalAbelianSubgroup.centralizer_eq_conj_SZ_of_IsConj_s_or_IsConj_neg_s, SpecialSubgroups.S_join_Z_eq_SZ, MaximalAbelianSubgroup.conj_T_join_Z_meet_G_eq_conj_T_meet_G_join_Z, MaximalAbelianSubgroup.conj_inv_conj_eq, SpecialSubgroups.center_SL2_eq_Z,
  SpecialMatrices.order_s_eq_char, orderOf_injective, MaximalAbelianSubgroup.center_le, 
  MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_of_IsConj_d, IsElementaryAbelian.subgroupOf, IsPGroup.exists_le_sylow,
  MaximalAbelianSubgroup.exists_noncenter_of_card_center_lt_card_center_Sylow, MaximalAbelianSubgroup.mul_center_inj}
\lean{MaximalAbelianSubgroup.A_eq_Q_join_Z_of_IsConj_s_or_neg_s}
\leanok
Let $F$ be an algebraically closed field of characteristic $p$ and let $G$ be a finite subgroup of $\SL_2(F)$ containing $Z$, let $A$ be a subgroup of $\SL_2(F)$ which is a maximal abelian subgroup of $G$ and furthermore suppose $Z < A$ and $A = C_{\SL_2(F)}(x) \sqcap G$ where $x \in G \setminus Z \subseteq \SL_2(F)$ and $x$ is conjugate to $s_\sigma$ for some $\sigma \in F$
then there exists a finite nontrivial elementary abelian Sylow $p$-subgroup of $G$ such that $A = Q \sqcup Z$.
\end{theorem}
%PROOF


\begin{lemma}
\label{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z_of_center_ne}
\uses{MaximalAbelianSubgroup.center_not_mem, MaximalAbelianSubgroup.eq_centralizer_meet_of_center_lt, SL2_IsConj_d_or_IsConj_s_or_IsConj_neg_s_of_AlgClosed, MaximalAbelianSubgroup.A_eq_Q_join_Z_of_IsConj_s_or_neg_s}
\lean{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z_of_center_ne}
\leanok
If $G \ne Z(G)$ then an element of $A$ of $\mathfrak{M}$, the maximal abelian subgroups of $G$, is either cyclic group whose order is relatively prime to $p$, the characteristic of the field $F$; or of the form $Q \times Z = Q \sqcup Z$ where $Q$ is an elementary abelian Sylow $p$-subgroup of $G$.
\end{lemma}
\begin{proof}
  Since $Z \not \in \mathfrak{M}$, each $A \in \mathfrak{M}$ contains at least one $x \not \in Z$. By Proposition  \ref{6.3} this $x$ is conjugate to either $d_\delta$ or $\pm s_\sigma$ in $\SL_2(F)$. It suffices to only consider these cases: \\
  \\
   \space $\pmb{x}$ \textbf{conjugate to} $\pmb{d_\delta}$ \textbf{in} $\pmb {L}$. There is a $y \in L$ such that $x = y d_\delta y^{-1}$. Since $x \not \in Z$, we have $d_\delta \not \in Z$, because otherwise we get the contradiction,
  \begin{align*} x =  y d_\delta y^{-1} = d_\delta \in Z.
  \end{align*}
  Thus $\omega \neq \pm 1$. Let $A = C_G(x)$, since $C_G(x) \in \mathfrak{M}$ by part (i). Observe that
  \begin{align*}  C_G(d_\delta) &<  C_{\SL_2(F)}(d_\delta)  \tag{see proof of (i)}
  \\ &= D  \tag{by Lemma \ref{6.4ii}}
  \\ &\cong F^*.  \tag{by Lemma \ref{6.1b}}
  \end{align*}
  
  Since $A$ is conjugate to $C_G(d_\delta)$ by Proposition \ref{conjcent}, we have that $A$ is isomorphic to a finite subgroup of $F^*$ and by Lemma \ref{finsubcyc}, $A$ is cyclic. By Lagrange's Theorem any finite subgroup of $F^*$ has an order which divides $p^m - 1$ for some $m \in \mathbb{Z}^+$, and since $p \nmid (p^m - 1)$, $|A|$ is relatively prime to $p$. \\
  \\
   \space $\pmb{x}$ \textbf{conjugate to} $\pmb{\pm s_\sigma}$ \textbf{in} $\pmb{L}$. Again let $A = C_G(x) \in \mathfrak{M}$. $A$ is conjugate to $C_G({\pm s_\sigma})$ in $\SL_2(F)$ by Proposition \ref{conjcent}. Since $x \notin Z$, we have $\lambda \neq 0$. Observe that
  \begin{align*}  C_G({\pm s_\sigma}) &<  C_{\SL_2(F)}({\pm s_\sigma})
  \\&= T \times Z  \tag{by Lemma \ref{6.4i}}
  \\&\cong F \times Z. \tag{by Lemma \ref{6.1b}}
  \end{align*}
  
  So $A$ is isomorphic to a finite subgroup of $F \times Z$, call it $Q \times Z$. Now $A = Q \times Z \cong QZ$ by Corollary \ref{directproductZ}, which means that an arbitrary element of $A$ is of the form $q_1z_1$, where $q_1 \in Q$, $z_1 \in Z$.
  \begin{align*} q_1z_1q_2z_2 &= q_2z_2 q_1z_1, \tag{$A \in \mathfrak{M}$}
  \\ q_1q_2z_1z_2 &= q_2q_1z_1z_2, \tag{$z_1$, $z_2 \in Z$}
  \\  q_1q_2z_1z_2(z_1z_2)^{-1} &= q_2q_1z_1z_2(z_1z_2)^{-1},
  \\ q_1q_2 &= q_2q_1.
  \end{align*}
  Thus $Q$ is also abelian. Recall from the proof of Proposition \ref{6.3}(ii) that all non-trivial elements of $S$ have order $p$, so each non-trivial element of $Q$ has order $p$ which means that $Q$ is elementary abelian. Thus $Q$ has order $p^m$, for some $m \in \mathbb{Z}^+$. \\
  \\
  Now let $S$ be a Sylow $p$-subgroup containing $Q$. We apply Lemma \ref{IsElementaryAbelian.dvd_card} to determine that $p$ divides $|Z(S)|$, moreover $|Z(S)| \geq p$. \\
  \\
  If $p=2$, then $Z=I_L$ by Lemma \ref{6.2}. So $|Z| = 1$ and hence $|Z(S)| \geq 2 > |Z|$.\\
  If $p > 2$, then  $Z = \langle - I_L \rangle$ also by Lemma \ref{6.2}. So $|Z| = 2$ and again we get $|Z(S)| > 2 = |Z|$. \\
  \\
  So $Z(S)$ must contain at least one element which is not in $Z$, let $y$ be one such element. Let $s_1z_1$ be an arbitrary element of $S \times Z$.
  \begin{align*}
  (s_1z_1)y(s_1z_1)^{-1} &= (s_1z_1)y(z_1^{-1}s_1^{-1})
  \\ &= s_1y(z_1z_1^{-1})s_1^{-1} \tag{since $y \in L$, $z_1 \in Z$}
  \\ &= y(s_1s_1^{-1}) \tag{since $s_1 \in S$, $y \in Z(S)$}
  \\ &= y
  \end{align*}
  
  Thus $s_1z_1 \in C_G(y)$ and since it was chosen arbitrarily, $S \times Z \subset C_G(y)$. Also since $y \in G \! \setminus \! Z$ we have $C_G(y) \in \mathfrak{M}$ by part (i).
  
  \begin{equation*}
  A = Q \times Z \subset S \times Z \subset C_G(y).
  \end{equation*}
  
  Since $A$ and $C_G(y)$ are both in $\mathfrak{M}$ it must be that $A = C_G(y)$. This means $Q = S$ and $Q$ is a Sylow $p$-subgroup of G.\\
\end{proof}

\begin{theorem}
\label{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z}
\uses{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z_of_center_ne, MaximalAbelianSubgroup.IsCyclic_and_card_Coprime_CharP_of_center_eq}
\lean{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z}
\leanok
An element $A$ of $\mathfrak{M}$ is either a cyclic group whose order is relatively prime to $p$, or of the form $Q \times Z$ where $Q$ is an elementary abelian Sylow $p$-subgroup of $G$. \vspace{3mm}
\end{theorem}
\begin{proof}
  First consider the trivial case of $G=Z$.
  By \ref{MaximalAbelianSubgroup.IsCyclic_and_card_Coprime_CharP_of_center_eq} we yield that $A$ is cyclic and has cardinality coprime to $p$.
  \\
  Now assume $G \neq Z$.
  By \ref{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z_of_center_ne} we yield that $A$ is either a cyclic group whose order is relatively prime to $p$, or of the form $Q \times Z$ where $Q$ is an elementary abelian Sylow $p$-subgroup of $G$.
\end{proof}

\begin{theorem}
  \label{MaximalAbelianSubgroup.index_normalizer_le_two}
  \uses{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z, normalizer_subgroup_D_eq_DW}
  \lean{MaximalAbelianSubgroup.index_normalizer_le_two}
  \leanok
If $A \in \mathfrak{M}$ and $|A|$ is relatively prime to $p$, then we have $[N_G(A): A] \leq 2$. 

\end{theorem}
\begin{proof}
  (iv) If $|A| \leq 2$ then $A=Z=G$. So $A$ is trivially normal in $G$ and $[N_G(A): A] = 1$. \\
  \\
  Now assume that $|A| > 2$. Since $|A|$ is relatively prime to $p$, we have that $A$ is a cyclic group conjugate to a finite subgroup of $D$ in $\SL_2(F)$ by the proof of part \ref{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z}, call this subgroup ${\widetilde{A}}$. Thus both ${\widetilde{A}}$ and $D$ have orders greater than 2. Applying Proposition \ref{normalizer_subgroup_D_eq_DW} we observe that
  \begin{align}\label{norm1}  N_{\SL_2(F)}({\widetilde{A}}) = \langle D , w \rangle = N_{\SL_2(F)}(D).
  \end{align}
  
  Since $A$ and ${\widetilde{A}}$ are conjugate in $\SL_2(F)$, there exists an element $z \in L$ such that $zAz^{-1} = {\widetilde{A}}$. This $z$ determines an inner automorphism of $\SL_2(F)$ defined by
  \begin{align*} 
      i_z: L \longrightarrow L,  \qquad \text{where} \quad  i_z(t) = z t z^{-1}  \quad \forall \; t \in L.
  \end{align*}
  
  Let $i_z(G) = {\widetilde{G}}$ denote the image of $G$ under $i_z$. Since $A$ is a maximal abelain subgroup of $G$ it's a simple task to show that ${\widetilde{A}}$ is a maximal abelian subgroup of ${\widetilde{G}}$ and I will leave this to the reader to verify. We now show that $i_z(N_G(A)) = N_{\widetilde{G}}({\widetilde{A}})$ . Take an arbitrary $g \in N_G(A)$.
  \begin{align*} (z g z^{-1}) {\widetilde{A}} (z g z^{-1})^{-1} &= z g (z^{-1} {\widetilde{A}} z) g^{-1} z^{-1}
  \\ &=  z (g A g^{-1}) z^{-1} \tag{since $zAz^{-1} = {\widetilde{A}}$ }
  \\ &= z A z^{-1} \tag{since $g \in N_G(A)$}
  \\ &= {\widetilde{A}}.
  \end{align*}
  
  So $z g z^{-1} = i_z(g) \in N_{\widetilde{G}}({\widetilde{A}})$ and since it was chosen arbitrarily, $i_z(N_G(A)) \subset N_{\widetilde{G}}({\widetilde{A}})$. Now take an arbitrary $z h z^{-1} \in N_{\widetilde{G}}({\widetilde{A}})$.
  \begin{align*} {\widetilde{A}} &= (z h z^{-1}) {\widetilde{A}} (z h z^{-1})^{-1}
  \\ &= z h (z^{-1} {\widetilde{A}} z) h^{-1} z^{-1}
  \\ &= z h A h^{-1} z^{-1}. \tag{since $A = z^{-1} {\widetilde{A}} z$}
  \end{align*}
  
  Now multiplication on the left by $z^{-1}$ and right by $z$ gives:
  \begin{align*} A = z^{-1} {\widetilde{A}} z = h A h^{-1},
  \end{align*}
  
  so $h \in N_G(A)$. Furthermore, $z h z^{-1}$ and indeed the whole of $N_{\widetilde{G}}({\widetilde{A}})$ is contained in $i_z(N_G(A))$. Thus $ i_z(N_G(A)) = N_{\widetilde{G}}({\widetilde{A}})$. In particular, we have,
  \begin{align}\label{6.8iv1} [N_G(A): A] = [N_{\widetilde{G}}({\widetilde{A}}): {\widetilde{A}}].
  \end{align}
  
  Since ${\widetilde{G}} < L$, the normaliser of ${\widetilde{A}}$ in ${\widetilde{G}}$ is simply the normaliser of ${\widetilde{A}}$ in $\SL_2(F)$ restricted to ${\widetilde{G}}$, thus $N_{\widetilde{G}}({\widetilde{A}}) < N_{\SL_2(F)}({\widetilde{A}}) = N_{\SL_2(F)}(D)$ by (\ref{norm1}). Now since $D \vartriangleleft N_{\SL_2(F)}(D)$, the Second Isomorphism Theorem shows that,
  \begin{align}\label{2iso} N_{\widetilde{G}}({\widetilde{A}})/( N_{\widetilde{G}}({\widetilde{A}}) \cap D) \; \cong \; DN_{\widetilde{G}}({\widetilde{A}}) / D.
  \end{align}
  \\
  Clearly ${\widetilde{A}} \subset {\widetilde{G}} \cap D$. We show that this inclusion is infact an equality. Assume that there exists some $d_\delta \in  {\widetilde{G}} \cap D$ which is not in ${\widetilde{A}}$. The group $\langle d_\delta , {\widetilde{A}} \rangle$ is thus an abelian subgroup of ${\widetilde{G}}$, strictly larger than ${\widetilde{A}}$ and contradicting the fact that ${\widetilde{A}}$ is maximal abelian in ${\widetilde{G}}$. Thus ${\widetilde{A}} =  {\widetilde{G}} \cap D$. It is trivial to see that ${\widetilde{A}} \subset N_{\widetilde{G}}({\widetilde{A}}) \cap D$. Also $N_{\widetilde{G}}({\widetilde{A}}) \cap D \subset {\widetilde{G}} \cap D = {\widetilde{A}}$. So,
  \begin{align}\label{parti} {\widetilde{A}} =  N_{\widetilde{G}}({\widetilde{A}}) \cap D.
  \end{align}
  
  Observe also that, 
  \begin{align}\label{index1or2} DN_{\widetilde{G}}({\widetilde{A}}) = \{ D, \langle D, w \rangle \} \subset \langle D, w \rangle = N_{\SL_2(F)}(D).
  \end{align}
  
  Now we piece the preceding results together to give the desired result.
  \begin{align*}  N_{\widetilde{G}}({\widetilde{A}}) / {\widetilde{A}} \; & \cong \;  N_{\widetilde{G}}({\widetilde{A}})/( N_{\widetilde{G}}({\widetilde{A}}) \cap D) \tag{by (\ref{parti})}
  \\ & \cong \; DN_{\widetilde{G}}({\widetilde{A}}) / D \tag{by (\ref{2iso})}
  \\ & \subset N_{\SL_2(F)}(D) / D \tag{by (\ref{index1or2})}
  \\ &= \langle D, w \rangle / D \; \cong \; \mathbb{Z}_2.
  \end{align*}
  
  We have shown that $N_{\widetilde{G}}({\widetilde{A}}) / {\widetilde{A}}$ is isomorphic to a subset of $\mathbb{Z}_2$. Thus by (\ref{6.8iv1}) we have established that, $$[N_G(A): A] = [N_{\widetilde{G}}({\widetilde{A}}): {\widetilde{A}}] \leq 2.$$
  \vspace{-2mm}
\end{proof}


\begin{theorem}
  \label{MaximalAbelianSubgroup.of_index_normalizer_eq_two}
  \uses{MaximalAbelianSubgroup.index_normalizer_le_two}
  \lean{MaximalAbelianSubgroup.of_index_normalizer_eq_two}
  If $A \in \mathfrak{M}$, $|A|$ is relatively prime to $p$, and if $[N_G(A): A] = 2$, then there is an element $y$ of $N_G(A) \! \setminus \! A$ such that, 
  \vspace{-1mm}
  \begin{align*} yxy^{-1} = x^{-1} \qquad \forall x \in A.\end{align*}
  \end{theorem}
\end{theorem}
\begin{proof}
  
  If $[N_G(A): A] = 2$, then the above argument at \ref{MaximalAbelianSubgroup.index_normalizer_le_two} shows that $N_{\widetilde{G}}({\widetilde{A}}) / {\widetilde{A}} \; \cong \; \mathbb{Z}_2$. Thus $DN_{\widetilde{G}}({\widetilde{A}}) = N_{\SL_2(F)}(D) = \langle D, w \rangle$. This means that $N_{\widetilde{G}}({\widetilde{A}})$ contains some element $wd_\omega$. In fact, since $w d_\delta \not \in D$, we have $w d_\delta \in N_{\widetilde{G}}({\widetilde{A}}) \! \setminus \! {\widetilde{A}}$. Take any element $x \in A$. Since ${\widetilde{A}} = zAz^{-1}$, $zxz^{-1} \in {\widetilde{A}}$, call it $d_\sigma$. Let $y = z^{-1}w d_\delta z$. Since $wd_\omega \in N_{\widetilde{G}}({\widetilde{A}}) \! \setminus \! {\widetilde{A}}$ it follows that $y \in N_G(A)\! \setminus \! A$. We show that this $y$ inverts $x$:
  \begin{align*} yxy^{-1} &= (z^{-1}w d_\delta z)(z^{-1} d_\sigma z)(z^{-1}d^{-1}_\omega w^{-1} z)
  \\ &= z^{-1} w d_\delta  d_\sigma d^{-1}_\omega w^{-1} z
  \\ &=  z^{-1} w  d_\sigma  w^{-1} z 
  \\ &=  z^{-1}  d^{-1}_\sigma z  \tag{by Lemma \ref{6.1}}
  \\ &= x^{-1}.
  \end{align*}
\end{proof}


\begin{theorem}
  \label{MaximalAbelianSubgroup.exists_IsCyclic_K_normalizer_eq_Q_join_K}
  \uses{normalizer_subgroup_S_le_L, MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z}
  \lean{MaximalAbelianSubgroup.exists_IsCyclic_K_normalizer_eq_Q_join_K}
  Let $Q$ be a Sylow $p$-subgroup of $G$. If $Q \neq \{I_G\}$, then there is a cyclic subgroup $K$ of $G$ such that $N_G(Q) = Q \sqcup K = QK$. \\
\end{theorem}
\begin{proof}
By part \ref{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z}, $Q$ is conjugate to a finite subgroup of $S$ in $\SL_2(F)$. In fact, without loss of generality we can assume that $Q \subset S$, moreoever $Q \subset S \cap G$. We show that this is in fact an equality by showing that the reverse inclusion also holds. 
Let $s_\sigma$ be an arbitrary element of $S \cap G$. Then $\langle s_\sigma, Q \rangle$ is a $p$-group of $G$ which must be equal to $Q$ since it is a Sylow $p$-subgroup of $G$. Thus $s_\sigma \in Q$ and
\begin{align}\label{Q=TNG} Q = S \cap G.
\end{align}

Since $|Q| > 1$, Proposition \ref{normalizer_subgroup_S_le_L} gives that $N_G(Q) \subset N_{\SL_2(F)}(Q) \subset H$. So $N_G(Q) \subset H \cap G$. Now take an arbitrarily chosen $d_\delta s_\sigma \in H \cap G$ and $s_\gamma \in Q$.
\begin{align*} (d_\delta s_\sigma) s_\gamma (d_\delta s_\sigma)^{-1} &= d_\delta ( s_\sigma s_\gamma  s_{-\sigma}) d^{-1}_\delta
\\ &=  d_\delta s_\gamma d^{-1}_\delta \tag{by Lemma \ref{6.1}}
\\ &= t_\sigma. \tag{where $\sigma = \mu \omega^{-2}$, by Lemma \ref{6.1}}
\end{align*}

Since it is a product of elements of $G$, $s_\sigma \in S \cap G = Q$ by (\ref{Q=TNG}). Thus $d_\delta s_\sigma \in N_G(Q)$ and indeed the whole of $H \cap G$ is contained in $N_G(Q)$ and
\begin{align}\label{normQ=HNG} N_G(Q) = H \cap G.
\end{align}

We now define a map $\phi$ by,
\begin{align*} \phi : N_G(Q) \longrightarrow D, \qquad \text{where} \quad \! \phi(d_\delta s_\sigma) = d_\delta \quad \forall \; d_\delta s_\sigma \in N_G(Q).
\end{align*}

Next we determine the kernel of $\phi$.
\begin{align*} \ker(\phi) &= \{ d_\delta s_\sigma \in N_G(Q) : \phi(d_\delta s_\sigma) = I_G \}
\\ &= N_G(Q) \cap T
\\ &= H \cap G \cap T \tag{by (\ref{normQ=HNG})}
\\ &= T \cap G = Q. \tag{by (\ref{Q=TNG})}
\end{align*}

We show that $\phi$ is a group homomorphism. Take $d_\delta s_\sigma$, $d_\rho s_\gamma$ from $ N_G(Q)$.
\begin{align*} \phi(d_\delta s_\sigma d_\rho s_\gamma) &= \phi(d_\delta d_\rho t_\sigma s_\gamma) \tag{where $\sigma = \lambda \rho^2$, by Lemma \ref{6.1}}
\\ &= d_\delta d_\rho
\\ &= \phi(d_\delta s_\sigma) \phi(d_\rho s_\gamma).
\end{align*}

Thus by the First Isomorphism Theorem,
\begin{align}\label{6.8viso} N_G(Q) / Q &\cong \phi(N_G(Q)),
\end{align}

Since $N_G(Q)$ is a finite group, it's image under $\phi$ is thus a finite subgroup of $D$. Furthermore, since $D \cong F^*$ (by Lemma \ref{6.1b}), $\phi(N_G(Q))$ is a cyclic group whose order divides $p^m-1$ and is therefore relatively prime to $p$, and by \eqref{6.8viso}, so too is $N_G(Q) / Q$. \\
\\
Let $r$ be the order of $N_G(Q) / Q$. Since it is cyclic, $N_G(Q)/Q$ is generated by a single element, namely a coset of $Q$ in $N_G(Q)$, call it $kQ$. So $|kQ| = r$. Observe that,
\begin{align*} (kQ)^r &= Q,
\\ k^rQ &= Q,
\\ k^r &\in Q.
\end{align*}
Since $Q$ is elementary abelian, each of it's non-trivial elements has order $p$, so $k$ has order $r$ or $rp$. In either case, since gcd$(r,p)=1$, the order of $k^p$ is $r$. Let $K = \langle k^p \rangle$. Now $|K| = r$ and
\begin{align*} |N_G(Q)| &= r|Q|
\\ &= |K||Q|
\\ &= |QK|. \tag{since $Q \cap K = I_G$} 
\end{align*}
Thus,
\begin{align}\label{QK} N_G(Q) &= QK.
\end{align}
\end{proof}



\begin{theorem}
  \label{MaximalAbelianSubgroup.K_mem_MaximalAbelianSubgroups_of_center_lt_card_K}
  \uses{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z}
  \lean{MaximalAbelianSubgroup.K_mem_MaximalAbelianSubgroups_of_center_lt_card_K}
  Let $Q$ be a Sylow $p$-subgroup of $G$. If $Q \neq \{I_G\}$, then there is a cyclic subgroup $K$ of $G$ such that $N_G(Q) = Q \sqcup K = QK$. Furthermore, If $|K| > |Z|$, then $K \in \mathfrak{M}$
\end{theorem}
\begin{proof} 
Assume $|K| > |Z|$. Since $K$ is abelian, it must be contained in some maximal abelian group $A \in \mathfrak{M}$. By part \ref{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z}, $A$ must also be a cyclic group whose order is relatively prime to $p$. \\
\\
Since $A$ is conjugate in $\SL_2(F)$ to a subgroup of $D$, each non-central element of $A$ has exactly 2 fixed points on the projective line $\mathscr{L}$ by Proposition \ref{6.7}. Let $A = \langle x \rangle$ and let $P_1$ and $P_2$ be the points fixed by $x$. We show by induction on $n$ that $x^n$ also fixes $P_1$ and $P_2$, for all $n \in \mathbb{Z^+}$. We do this by assuming first that $x^{n-1}$ fixes $P_i$.
\begin{align*} x^n P_i = x(x^{n-1} P_i) = x (P_i) = P_i.
\end{align*}

The importance of this is that since each element of $A$ can be expressed as some power of $x$, they must have the same two fixed points, namely $P_1$ and $P_2$. In other words, 
\begin{align}\label{stab} A \subset S_L(P_i), \qquad (\text{$i$ = 1 or 2})
\end{align}

By Proposition \ref{6.7}(ii), each element of $S$ has a common fixed point $P$ and Stab$(P) = H$. Since $K \subset H$, each element in $K$ fixes $P$. Also, since $K \subset A$, this $P$ must be equal to either $P_1$ or $P_2$. Therefore by (\ref{stab}), $A \subset \text{Stab}(P) = H$. We arrive at the following result:
\begin{align*} A &\subset H \cap G 
\\ &= N_G(Q) \tag{by (\ref{normQ=HNG})}
\\ &= QK. \tag{by (\ref{QK})}
\end{align*}

Furthermore, we get,
\begin{align*} A &= QK \cap A
\\ &= QK \cap AK \tag{$K \subset A$ so $A = AK$}
\\ &= (Q \cap A)K
\\ &= K \tag{$Q \cap A = I_G$}
\end{align*}

Thus $K \in \mathfrak{M}$.\\
\\
\end{proof}

For the duration of this paper, unless otherwise stated, $Q$ will denote a Sylow $p$-subgroup of $G$ and $K$ will be as described above. 


\section{Conjugacy of Maximal Abelian Subgroups}

\begin{definition}
  \label{ConjClassOfSet}
  \uses{MaximalAbelianSubgroupsOf}
  \lean{ConjClassOfSet}
  \leanok
  Let $G$ be a subgroup of $\SL_2(F)$ and let $A \in \mathfrak{M}$ then define the conjugacy class of $A$ to be 
  \[
  \mathcal{C}(A) = \{ x A x^{-1} : x \in G \}.
  \]
\end{definition}

\begin{definition}[Noncenter of a subgroup]
  \label{Subgroup.noncenter}
  \lean{Subgroup.noncenter}
  \leanok
  Let $A$ be a subgroup of a group $G$ let $A^* = A \setminus Z(G)$ be the "noncenter" part of $A$.
\end{definition}

Now we define the noncenter version of \ref{ConjClassOfSet}

\begin{definition}
  \label{noncenter_ConjClassOfSet}
  \uses{MaximalAbelianSubgroupsOf, Subgroup.noncenter}
  \lean{noncenter_ConjClassOfSet}
  \leanok
  Let $G$ be a subgroup of $\SL_2(F)$ and let $A^* \in \mathfrak{M}^*$ then define the conjugacy class of $A^*$ to be
  \[
  \mathcal{C}(A^*) = \left\{x A^* x^{-1} \; | \; x \in G \right\}
   \]
\end{definition}

\begin{definition}
\label{noncenter_MaximalAbelianSubgroupsOf}
\uses{MaximalAbelianSubgroupsOf, Subgroup.noncenter}
\lean{noncenter_MaximalAbelianSubgroupsOf}
\leanok
Let $\mathfrak{M}^*$ be the set of all $A_i^*$ and let $\mathcal{C}_i^*$ be the conjugacy class of $A_i^*$. \\
\end{definition}

\begin{definition}[Conjugacy class of subgroup]
\label{C}
\lean{C}
\leanok
Let $A \in \mathfrak{M}$ and define the union of the conjugacy classes of $A$ to
\begin{align*} 
  C(A) = \bigcup_{x \in G} x A x^{-1}
\end{align*}
\end{definition}

Similarly, we define the analogous for the noncenter part of a maximal abelian subgroup:

\begin{definition}[Union of conjugacy class of noncenter part of a subgroup]
  \label{noncenter_C}
  \lean{noncenter_C}
  \leanok
  Let $A^* \in \mathfrak{M}^*$ then denote union of the conjugacy class of $A^*$ to be
\begin{align*}
  C(A^*) = \bigcup_{x \in G} x A^* x^{-1} = \bigcup_{B \in \mathcal{C}(A^*)} B.
\end{align*}
\end{definition}


In other words, $C_i$ denotes the set of elements of $G$ which belong to some element of $\mathcal{C}_i$. It's evident that $C_i^* = C_i \setminus Z$ and that there is a $C_i$ corresponding to each $\mathcal{C}_i$. Clearly we have the relation,

\begin{lemma}
\label{card_noncenter_C_eq_noncenter_MaximalAbelianSubgroup_mul_noncenter_ConjClassOfSet}
\uses{noncenter_MaximalAbelianSubgroupsOf, card_noncenter_C, card_noncenter_MaximalAbelianSubgroupsOf, card_noncenter_ConjClassOfSet}
\lean{card_noncenter_C_eq_noncenter_MaximalAbelianSubgroup_mul_noncenter_ConjClassOfSet}
\begin{align} |C_i^*| = |A_i^*||\mathcal{C}_i^*|.
\end{align}
\end{lemma}

Here the argument from Christopher Butler's exposition has been modified, it turns out to be significantly more
idiomatic to lean to first define the following equivalence relation and its corresponding quotient to eventually set up
the maximal abelian class equation.

\begin{lemma}[Equivalence relation on $\mathfrak{M}^*$]
\label{lift_noncenter_MaximalAbelianSubgroupsOf}
\uses{MaximalAbelianSubgroupsOf}
\lean{lift_noncenter_MaximalAbelianSubgroupsOf}
\leanok
 Let $G$ be a finite subgroup of $\SL_2(F)$, then the relation $\sim$ on the set of noncenter part of maximal abelian subgroups of $G$, $\mathfrak{M}^*$ defined by
 \[
 A \sim B \text{ if and only if } \exists x \in G \text{ such that } x A x^{-1} = B
 \]
 gives an equivalence relation.
\end{lemma}

\begin{proof}
 We show the relation $\sim$ defined above is in fact an equivalence relation on  $\mathfrak{M}^*$:

\begin{itemize}
\item $\sim$ is reflexive:

For any $x \in A$ as conjugation by an element in the subgroup defines an automorphism and so $A = x A x^{-1}$ as this automorphism fixes the subgroup.

Therefore, $A \sim A$ and $\sim$ is thus reflexive.

\item $\sim$ is symmetric:

If $A \sim B$, then $\exists \; x \in G$ such that,
\begin{align*} A = xBx^{-1} \iff x^{-1}Ax = B \iff B = yAy^{-1} \quad \text{for} \; y = x^{-1} \in G.
\end{align*}

Thus $B \sim A$ and $\sim$ is symmetric.\\

\item $\sim$ is transitive:

If $A \sim B$ and $B \sim C$, then $\exists \; x, y \in G$  such that,
\begin{align*} A = xBx^{-1} \; \text{and} \; B = yCy^{-1} \Rightarrow A = xyCy^{-1}x^{-1} = (xy)C(xy)^{-1}.
\end{align*}
Thus $A \sim C$ (since $xy \in G$), which shows that $\sim$ is transitive. \\
\end{itemize}

Therefore, we have shown that $\sim$ relation is in fact an equivalence relation on $\mathfrak{M}$
\end{proof}

\begin{remark}[Setoid type in Lean]
  TODO
\end{remark}

Now that we have set up the equivalence relation on maximal abelian subgroups we proceed to lift particular functions that will be of interest to set up the maximal abelian class equation and 
other suitable results.

\begin{lemma}[Equivalent noncenter subgroups of $\mathfrak{M}^*$ have the equal union of their conjugacy class]
  \label{noncenter_C_eq_of_related}
  \uses{noncenter_C, noncenter_MaximalAbelianSubgroupsOf}
  \lean{noncenter_C_eq_of_related}
  Let $G$ be a subgroup of $\SL_2(F)$ and let $A , B \in \mathfrak{M}*$ be a noncenter maximal abelian subgroups of $G$ where $A \sim B$
  then 
  \[
  \bigcup_{x \in G} x A x^{-1} = \bigcup_{x \in G} x B x^{-1}
  \]
\end{lemma}
% PROOF

\begin{definition}[Lift of the union of the conjugacy class of noncenter of a subgroup]
\label{lift_noncenter_C}
\uses{noncenter_C, noncenter_C_eq_of_related, noncenter_MaximalAbelianSubgroupsOf}
\lean{lift_noncenter_C}
\leanok
 Let $[A^*] \in \mathfrak{M}^* / \sim$, given for all $A^* \sim B^*$ we have that $C(A^*) = C(B^*)$ by \ref{noncenter_C_eq_of_related} we can define the lift of $C : \mathfrak{M}^* \rightarrow \mathcal{P}(\SL_2(F))$ to be 
  $\tilde{C}([A^*]) = \bigcup_{x \in G} x A^* x^{-1}$ where this map is well-defined for any choice of a representative of $[A^*]$.
\end{definition}

\begin{theorem}[The union of conjugacy classes of the set representatives of $\mathfrak{M}^* / \sim$ cover $G \setminus Z(\SL_2(F))$]
\label{union_lift_noncenter_C_eq_G_diff_center}
\uses{lift_noncenter_MaximalAbelianSubgroupsOf, lift_noncenter_C}
\lean{union_lift_noncenter_C_eq_G_diff_center}
  Let $G$ be a finite subgroup of $\SL_2(F)$ provided $\mathfrak{M}^* / \sim$ is a finite then we have the set equality
  \[
   G \setminus Z(\SL_2(F)) = \bigcup_{[A^*] \in \mathfrak{M}^* / \sim} C([A^*])
  \]
\end{theorem}
% PROOF

\begin{theorem}[Distinct elements of $\mathfrak{M}^* / \sim$ are mapped to disjoint sets through $\tilde{C}$]
  \label{disjoint_of_ne_lift_noncenter_MaximalAbelianSubgroupsOf}
  \uses{lift_noncenter_MaximalAbelianSubgroupsOf, lift_noncenter_C}
  \lean{disjoint_of_ne_lift_noncenter_MaximalAbelianSubgroupsOf}
  Let $[A^*], [B^*] \in \mathfrak{M}^* / \sim$ then
  \[
  \tilde{C}([A^*]) = \tilde{C}([B^*]) \iff [A^*] = [B^*]
  \]
  Or equivalently,
  \[ 
  C(A^*) \cap C(B^*) = \varnothing, \qquad \forall \;  A^* \not\sim B^* 
  \]
\end{theorem}
% PROOF

\begin{theorem}
  \label{card_noncenter_ConjClassOfSet_eq_card_ConjClassOfSet}
  \uses{MaximalAbelianSubgroupsOf, noncenter_MaximalAbelianSubgroupsOf, noncenter_ConjClassOfSet, ConjClassOfSet}
  \lean{card_noncenter_ConjClassOfSet_eq_card_ConjClassOfSet}
  For all maximal abelian subgroups $A \in \mathfrak{M}$ we have that 
  \[
  |\mathcal{C}(A)| = |\mathcal{C}(A^*)|
  \]
\end{theorem}
% PROOF


\begin{theorem}
\label{card_ConjClassOfSet_eq_index_normalizer}
\uses{MaximalAbelianSubgroupsOf, ConjClassOfSet}
\lean{card_ConjClassOfSet_eq_index_normalizer}

Let $G$ be a finite subgroup of $\SL_2(F)$ and let $A$ be a maximal abelian subgroup of $G$, 
$A \in \mathfrak{M}$ then $|\mathcal{C}(A)| = [G : N_G(A)]$.
\end{theorem}
%PROOF

\begin{theorem}[The maximal subgroup class equation]
  \label{card_noncenter_fin_subgroup_eq_sum_card_noncenter_mul_index_normalizer}
  \uses{lift_noncenter_MaximalAbelianSubgroupsOf, lift_card_noncenter, lift_card_noncenter_C}
  \lean{card_noncenter_fin_subgroup_eq_sum_card_noncenter_mul_index_normalizer}

Let $G$ be a finite subgroup of $\SL_2(F)$, define the equivalence relation on the maximal abelian subgroups of $G$, $\mathfrak{M}^*$ as above in \ref{lift_noncenter_MaximalAbelianSubgroupsOf}
then 
$|G \! \setminus  \! Z| = \sum_{[A^*] \in \mathfrak{M}^* / \sim} |A^*| [\tilde{C}([A^*])].$

\end{theorem}
% PROOF

\begin{proof}
(i)
\\
The equivalence class of $A_i^*$ in $\mathfrak{M}^*$ therefore coincides with the set $\mathcal{C}_i^* = \{ xA_i^*x^{-1} : x \in G \}$. Furthermore, this tells us that each $A_i^*$ belongs to exactly one conjugacy class. Thus the conjugacy classes $\mathcal{C}_i^*$ form a partition of $\mathfrak{M}^*$,
\begin{align*} \mathfrak{M}^* = \bigcup\limits_{A_i^* \in S} \mathcal{C}_i^*,  \qquad \text{and}  \qquad \mathcal{C}_i^* \cap \mathcal{C}_j^* = \varnothing, \qquad \forall \; i \neq j.
\end{align*}

Since the set of $\mathcal{C}_i^*$ are pairwise disjoint, it follows that the set of $C_i^*$ are also pairwise disjoint and we get the desired result,

\begin{align*} G \! \setminus \! Z = \bigcup\limits_{A_i^* \in S} C_i^*,  \qquad \text{and}  \qquad C_i^* \cap C_j^* = \varnothing, \qquad \forall \; i \neq j.
\end{align*}

(ii) Let $x A_i x^{-1} \in \mathcal{C}_i$ and $x A_i^* x^{-1} \in \mathcal{C}_i^*$. Since $x A_i x^{-1} \! \setminus \! Z = x A_i^* x^{-1}$, it is quite clear that,
\begin{align*} x A_i x^{-1} \in \mathcal{C}_i \iff x A_i^* x^{-1} \in \mathcal{C}_i^*.
\end{align*}
Thus $|\mathcal{C}_i^*| = |\mathcal{C}_i|$ as desired. \\
\\
(iii) Now we define a map $\phi$ by:
\begin{align*} \phi: \mathcal{C}_i &\longrightarrow G / N_G(A_i),
\\ \phi(xA_ix^{-1}) &= xN_G(A_i). \tag{$\forall \; x \in G, \; A_i \in \mathfrak{M}$}
\end{align*}

Clearly $\phi$ is trivially surjective. We now show that it is both well-defined and injective.
\begin{align*} xN_G(A_i) = yN_G(A_i) &\iff y^{-1}xN_G(A_i) = N_G(A_i) \\
&\iff y^{-1}x \in N_G(A_i) \\
&\iff (y^{-1}x)A_i(y^{-1}x)^{-1} = A_i \\
&\iff y^{-1}xA_ix^{-1}y = A_i \\
&\iff xA_ix^{-1} = yA_iy^{-1}.
\end{align*}

Hence $\phi$ is well-defined and injective. This shows that $\phi$ is a bijection proving that $|\mathcal{C}_i| = [G:N_G(A_i)]$. This is a crucial result which shows that the number of maximal abelian subgroups conjugate to $A_i$ is equal to the index of the normaliser of $A_i$ in $G$. \\
\\
(iv) This follows directly from parts (i), (ii) and (iii) and \eqref{orderorder}.
\begin{align*} G \! \setminus \! Z &= \bigcup\limits_{A_i^* \in S} C_i^*,  \qquad \text{and}  \qquad C_i^* \cap C_j^* = \varnothing, \qquad \forall \;  i \neq j, \\
 |G \! \setminus \! Z| &=  \sum_{A_i^* \in S} |C_i^*| = \sum_{A_i^* \in S} |A_i^*||\mathcal{C}_i^*| = \sum_{A_i^* \in S} |A_i^*||\mathcal{C}_i|
\\ &= \sum_{A_i^* \in S} |A_i^*| [G:N_G(A_i)].
\end{align*}

\end{proof}

This theorem proves that the non-central parts of the maximal abelian subgroups form a partition of the non-central part of $G$. This will serve as a powerful tool in decomposing $G$ and counting its elements.

\section{Constructing The Class Equation}

It is necessary to prove the following 2 short lemmas before we proceed further.
 
\begin{lemma}
\label{normalizer_noncentral_eq}
\lean{normalizer_noncentral_eq} $N_G(A) =N_G(A^*)$.
\end{lemma}

\begin{proof}
(iii) Let $x \in N_G(A^*)$. Take an arbitary $a \in A = A^* \cup Z$. If $a \in A^*$, then since  $x \in N_G(A^*)$, we have $xax^{-1} \in A^* \subset A$. If $a \in Z$, then $xzx^{-1} = zxx^{-1} = z \in A$. Therefore $x$ is in the normaliser of $A$ and $N_G(A^*) \subset N_G(A)$. \\
\\
Conversely, take $y \in N_G(A)$ and $a \in A^*$. $yay^{-1} \in A = A^* \cup Z$. If  $yay^{-1} \in Z$, then
\begin{align*} yay^{-1} &= z, \tag{some $z \in Z$}
\\ a &= y^{-1}zy = y^{-1}yz = z \not \in A^*.
\end{align*}
This contradicts the fact that $a \in A^*$. Therefore $yay^{-1} \in A^*$ and $y \in N_G(A^*)$. Since $y$ was chosen arbitrarily we get $N_G(A) \subset N_G(A^*)$ and hence $N_G(A) =N_G(A^*)$.

\end{proof}

\begin{lemma}
\label{normalizer_Sylow_join_center_eq_normalizer_Sylow}
\uses{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z, MaximalAbelianSubgroup.index_normalizer_le_two}
\lean{normalizer_Sylow_join_center_eq_normalizer_Sylow}
$N_G(Q \times Z) = N_G(Q)$.
\end{lemma}

\begin{proof} 

If $p = 2$ then $Z = I_G$ and the result is trivial. Now assume $p \neq 2$. Thus $|Z| = 2$. Let $x$ and $q_1$ be arbitrarily chosen elements of $N_G(Q)$ and $Q$ respectively.
\begin{align*} xq_1x^{-1} &= q_2, \tag{for some $q_2 \in Q$}
\\ xq_1x^{-1}z_1 &= q_2z_1,
\\ xq_1z_1x^{-1} &= q_2z_1 \in Q \times Z.
\end{align*}
Thus any element $x$ which is in $N_G(Q)$ is also in $N_G(Q \times Z)$ so we have $N_G(Q) \subset N_G(Q \times Z)$. \\
\\
Let $q_1 z_1$ be an arbitrarily chosen element of $Q \times Z$ such that $q_1 \in Q$ and $z_1 \in Z$. Now let $y$ be an arbitrarily chosen element of $N_G(Q \times Z)$.
\begin{align*} y q_1 z_1 y^{-1} = q_2 z_2 \in Q \times Z. \qquad (\text{where $q_2 \in Q$ and $z_2 \in Z$}) 
\end{align*}

Consider now the order of $q_1z_1$ in $G$. Since $p \neq 2$, $Q \cap Z = I_G$ and $|q_1 z_1| = |q_1| |z_1|$. Note that $q_1 z_1$ and $q_2 z_2$ are conjugate in $G$, and thus their orders are equal. This means that $|z_1| = |z_2|$, because otherwise 2 would divide one of them and not the other. Thus $z_1 = z_2$ and,
\begin{align*} y q_1z_1 y^{-1} &=  q_2z_2 = q_2z_1
\\ y q_1 y^{-1} z_1 &= q_2z_1,
\\ y q_1 y^{-1} &= q_2 \in Q
\end{align*}
Hence $y \in N_G(Q)$. Furthermore, since $y$ was chosen arbitrarily, any element which is in $N_G(Q \times Z)$ is also in $N_G(Q)$, so $N_G(Q \times Z) = N_G(Q)$ as desired.

\end{proof}

We now start to count the elements of the seperate components of $G$ and use the preceeding 2 theorems to construct what will be an invaluable formula in determining the structure of $G$, something we will call the \textbf{Maximal Abelian Subgroup Class Equation} of $G$. \\
\\
First we split $\mathfrak{M}$ into the conjugacy classes of it's elements. Theorem \ref{MaximalAbelianSubgroup.IsCyclic_and_card_coprime_CharP_or_eq_Q_join_Z} tells us that every maximal abelian subgroup is either a cyclic subgroup whose order is relatively prime to $p$ or of the form $Q \times Z$ where $Q$ is a Sylow $p$-subgroup. Let $\mathcal{C}_1, \mathcal{C}_2,...,\mathcal{C}_s, \mathcal{C}_{s+1},..., \mathcal{C}_{s+t}$ (where $s, t \in \mathbb{Z}^+$) denote the conjugacy classes of the cyclic subgroups whose order is relatively prime to $p$. Recall that part (iv) of Theorem \ref{MaximalAbelianSubgroup.index_normalizer_le_two} tells us that $[N_G(A): A] = 1$ or 2. Let $A_i$ be a representative from each $\mathcal{C}_i$ such that,
\begin{align*} [N_G(A_i) : A_i] &= 1, \tag{for  $i \leq s$} \\[2mm]
[N_G(A_i) : A_i] &= 2. \tag{for  $s < i \leq s+t$}, \end{align*}

Now let $Q_1$ and $Q_2$ be any two Sylow $p$-subgroups of $G$. By the Second Sylow Theorem, $Q_1$ and $Q_2$ are conjugate to each other in $G$. That is, there exists a $g \in G$ such that $gQ_1g^{-1} = Q_2$.

\begin{align*} gQ_1g^{-1} = Q_2 &\iff gQ_1g^{-1}Z = Q_2Z 
\\ &\iff gQ_1Zg^{-1} = Q_2Z
\\ &\iff g(Q_1 \times Z)g^{-1} = (Q_2 \times Z). \tag{by Corollary \ref{directproductZ}}
\end{align*} 

So $Q_1 \times Z$ and $Q_2 \times Z$ belong to the same conjugacy class, furthermore there is thus only 1 conjugacy class of elements of this form in $\mathfrak{M}$. Let $\mathcal{C}_{Q \times Z}$ denote this conjugacy class and let $Q \times Z$ be a representative from it. The following diagram provides a visual representation of $G$ divided into it's maximal abelian subgroups.

% \begin{center}
% \begin{tikzpicture}[thick, scale=0.4]

% \draw (0,0) ellipse (22pt and 22pt); 

% \draw[dashed][rotate around={308:(0,0)},red] (3,0) ellipse (108pt and 41pt);  
% \draw[dashed][rotate around={318:(0,0)},red] (3,0) ellipse (108pt and 41pt);  
% \draw[rotate around={328:(0,0)},red] (3,0) ellipse (108pt and 41pt); 
% \draw[dashed][rotate around={338:(0,0)},red] (3,0) ellipse (108pt and 41pt);  

% \draw[dashed][rotate around={301:(0,0)},lightgray] (3,0) ellipse (94pt and 37pt); 
% \draw[dashed][rotate around={296:(0,0)},lightgray] (3,0) ellipse (94pt and 37pt); 
% \draw[dashed][rotate around={291:(0,0)},lightgray] (3,0) ellipse (94pt and 37pt);  

% \draw[dashed][rotate around={258:(0,0)},orange] (2,0) ellipse (79pt and 37pt);  
% \draw[rotate around={270:(0,0)},orange] (2,0) ellipse (79pt and 37pt);  
% \draw[dashed][rotate around={282:(0,0)},orange] (2,0) ellipse (79pt and 37pt); 

% \draw[dashed][rotate around={198:(0,0)},cyan] (3.4,0) ellipse (120pt and 35pt);  
% \draw[rotate around={203:(0,0)},cyan] (3.4,0) ellipse (120pt and 35pt);
% \draw[dashed][rotate around={208:(0,0)},cyan] (3.4,0) ellipse (120pt and 35pt);
% \draw[dashed][rotate around={213:(0,0)},cyan] (3.4,0) ellipse (120pt and 35pt);
% \draw[dashed][rotate around={218:(0,0)},cyan] (3.4,0) ellipse (120pt and 35pt);

% \draw[dashed][rotate around={128:(0,0)},blue] (2,0) ellipse (79pt and 37pt);  
% \draw[rotate around={148:(0,0)},blue] (2,0) ellipse (79pt and 37pt);
% \draw[dashed][rotate around={168:(0,0)},blue] (2,0) ellipse (79pt and 37pt);

% \draw[dashed][rotate around={108:(0,0)},lightgray] (3,0) ellipse (94pt and 37pt); 
% \draw[dashed][rotate around={113:(0,0)},lightgray] (3,0) ellipse (94pt and 37pt); 
% \draw[dashed][rotate around={118:(0,0)},lightgray] (3,0) ellipse (94pt and 37pt); 

% \draw[dashed][rotate around={82:(0,0)},teal] (3,0) ellipse (108pt and 41pt);  
% \draw[rotate around={86:(0,0)},teal] (3,0) ellipse (108pt and 41pt);  
% \draw[dashed][rotate around={90:(0,0)},teal] (3,0) ellipse (108pt and 41pt);  
% \draw[dashed][rotate around={94:(0,0)},teal] (3,0) ellipse (108pt and 41pt);  
% \draw[dashed][rotate around={98:(0,0)},teal] (3,0) ellipse (108pt and 41pt);  

% \draw[dashed][rotate around={18:(0,0)},green] (3.4,0) ellipse (120pt and 35pt);
% \draw[rotate around={26:(0,0)},green] (3.4,0) ellipse (120pt and 35pt);
% \draw[dashed][rotate around={34:(0,0)},green] (3.4,0) ellipse (120pt and 35pt); 

% \node[] at (0,-10) {\resizebox{8cm}{!}{Fig 1: $G$ arranged into it's maximal abelian subgroups}};
% \node[] at (0,0) {\resizebox{.3cm}{!}{$Z$}};

% \node[] at (6.1,-4.5) {\resizebox{.5cm}{!}{$A_1$}};
% \node[] at (-0.2,-5.6) {\resizebox{.5cm}{!}{$A_s$}};
% \node[] at (-7.8,-4.1) {\resizebox{.9cm}{!}{$A_{s+1}$}};
% \node[] at (-5.0,3.3) {\resizebox{.9cm}{!}{$A_{s+2}$}};
% \node[] at (0.2,7.6) {\resizebox{.9cm}{!}{$A_{s+t}$}};
% \node[] at (8.0,4.0) {\resizebox{1.1cm}{!}{$Q \times Z$}};

% \node[] at (7.9,-6.0) {\resizebox{.5cm}{!}{$\mathcal{C}_1$}};
% \node[] at (-0.2,-7.9) {\resizebox{.5cm}{!}{$\mathcal{C}_s$}};
% \node[] at (-10.9,-4.7) {\resizebox{1.0cm}{!}{$\mathcal{C}_{s+1}$}};
% \node[] at (-8.2,4.9) {\resizebox{1.0cm}{!}{$\mathcal{C}_{s+2}$}};
% \node[] at (-0.1,10.0) {\resizebox{1.0cm}{!}{$\mathcal{C}_{s+t}$}};
% \node[] at (11.6,5.1) {\resizebox{1.2cm}{!}{$\mathcal{C}_{Q \times Z}$}};

% \node[scale=1.6, rotate=143,gray] at (6.9,-5.1) { $\Bigg\{$ };
% \node[scale=1.1, rotate=90,gray] at (0,-6.6) { $\Bigg\{$ };
% \node[scale=1.3, rotate=28,gray] at (-8.9,-4.8) { $\Bigg\{$ };
% \node[scale=1.4, rotate=328,gray] at (-6.3,3.9) { $\Bigg\{$ };
% \node[scale=1.2, rotate=270,gray] at (0.0,8.7) { $\Bigg\{$ };
% \node[scale=1.2, rotate=206,gray] at (9.6,4.6) { $\Bigg\{$ };

% \end{tikzpicture}
% \end{center}

We can reformulate the counting formula in Theorem \ref{card_noncenter_fin_subgroup_eq_sum_card_noncenter_mul_index_normalizer} using the notation we have introduced to show that it agrees with the intuitive approach that Fig 1 suggests.
% MODIFY NOTATION

\begin{align*} 
  |G \! \setminus \! Z| = \sum_{A_i^* \in S} |A_i^*| [G:N_G(A_i)] = \sum_{A_i^* \in S} |C_i^*| = |C_{Q \times Z}^*| + \sum_{i=1}^{s+t} |C_i^*|.
\end{align*}

We are now able to begin to evaluate $G$. Firstly, let $|Z| = e$ and $|G| = eg$. We know well by now that $e = 1$ or 2 depending on whether $p$ equals 2 or not, and by Lagrange's Theorem, the order of a subgroup divides the order of the group, so $e$ divides $|G|$ since $Z < G$. \\
\\
We consider the cyclic case first. Again, by Lagrange's Theorem, since $Z$ is a subgroup of each $A_i$, $e$ divides $|A_i|$. So set $|A_i| = eg_i$. Since $Z \notin \mathfrak{M}$, each $A_i$ is therefore strictly larger than $Z$ and so each $g_i$ is an integer greater than or equal to 2. \\
\\
To determine the order of each $C_i$, we return to the set $\mathfrak{M}^*$. The size of one representative of each class is,
\begin{align*} |A_i^*| = |A_i \! \setminus \! Z| = eg_i-e = e(g_i-1). \end{align*}
The number of $A_i^*$ in each conjugacy class $\mathcal{C}_i$ for $i \leq s$ is thus,
\begin{align*} |\mathcal{C}_i^*| = |\mathcal{C}_i| = [G:N_G(A_i)] = \frac{|G|}{|A_i|} = \frac{eg}{eg_i} = \frac{g}{g_i}. \end{align*}
\\
Therefore the total number of elements of $G$ in the noncentral part of $C_i$ for $i \leq s$ is,
\begin{align} \label{classeq1of3} \sum_{i=1}^{s} |C_i^*| = \sum_{i=1}^{s} |A_i^*| |\mathcal{C}_i^*| = \sum_{i=1}^{s} \frac{eg(g_i-1)}{g_i}.
\end{align}
\\
The number of $A_i^*$ in each conjugacy class $\mathcal{C}_i$ for $s < i \leq s+t$ is thus,
\begin{align*} |\mathcal{C}_i^*| = |\mathcal{C}_i| = [G:N_G(A_i)] = \frac{|G|}{2|A_i|} = \frac{eg}{2eg_i} = \frac{g}{2g_i}. \end{align*}
\\
Therefore the total number of elements of $G$ in the noncentral part of $C_i$ for $s < i \leq s+t$ is,
\begin{align}\label{classeq2of3} \sum_{i=s+1}^{s+t} |C_i^*| = \sum_{i=s+1}^{s+t} |A_i^*| |\mathcal{C}_i^*| = \sum_{i=s+1}^{s+t} \frac{eg(g_i-1)}{2g_i}.
\end{align}
We next determine the order of $C_{Q \times Z}$. Let $|Q| = q$. If $p \nmid |G|$ then $q=1$ and if $p = 0$, then we consider a Sylow $p$-subgroup to simply be $I_G$. So $q$ is always at least 1. Since $Z < K$, we can let $|K| = ek$. Observe that if $K \in \mathfrak{M}$, then by Theorem \ref{6.8}(v), $K = A_i$ for some $0 < i \leq t$ and $k = g_i$. Recall that $N_G(Q) = QK$ and so,
\begin{align*} |N_G(Q \times Z)^*| &= |N_G(Q \times Z)|  \tag{by Lemma \ref{normalizer_noncentral_eq}}
\\ &= |N_G(Q)| \tag{by Lemma \ref{unsure}}
\\ &= |QK| = eqk.
\end{align*}

Again we count the size and number of these maximal abelian groups.
\begin{align*} |(Q \times Z)^*| = |QZ| - |Z| = e(q-1).
\end{align*}

Since there is only one conjugacy class of $Q \times Z$, the number of $(Q \times Z)^*$ in $\mathfrak{M}^*$ is thus,
\begin{align*} 
  |\mathcal{C}_{Q \times Z}^*| =  |\mathcal{C}_{Q \times Z}| =  [G: N_G(Q \times Z)] = \frac{|G|}{|N_G(Q \times Z)^*|} = \frac{eg}{eqk} = \frac{g}{qk}.
\end{align*}

Therefore the total number of elements of $G$ in the noncentral parts of each $Q \times Z$ is,
\begin{align} \label{classeq3of3} 
  |C_{Q \times Z}^*| = |(Q \times Z)^*| |\mathcal{C}_{Q \times Z}^*| = \frac{eg(q-1)}{qk}.
\end{align}

We now sum together (\ref{classeq1of3}), (\ref{classeq2of3}) and (\ref{classeq3of3}) to create the \textbf{Maximal Abelian Subgroup Class Equation} of $G$.

\begin{align}\label{classeq} |G \! \setminus \! Z| &= |C_{Q \times Z}^*| + \sum_{i=1}^{s+t} |C_i^*|, \nonumber \\
|G \! \setminus \! Z| &= |(Q \times Z)^*| |\mathcal{C}_{Q \times Z}^*| + \sum_{i=1}^{s} |A_i^*| |\mathcal{C}_i^*| + \sum_{i=s+1}^{s+t} |A_i^*| |\mathcal{C}_i^*|, \nonumber \\
eg - e &= \frac{eg(q-1)}{qk} + \sum_{i=1}^{s} \frac{eg(g_i-1)}{g_i} + \sum_{i=s+1}^{s+t} \frac{eg(g_i-1)}{2g_i}, \nonumber \\
1 &= \frac{1}{g} + \frac{q-1}{qk} + \sum_{i=1}^{s} \frac{g_i-1}{g_i} + \sum_{i=s+1}^{s+t} \frac{g_i-1}{2g_i}.
\end{align}

Since $g,k,q \in \mathbb{Z}^+$ this implies that,
\begin{align*} \frac{1}{g} > 0 \quad \text{and} \quad \frac{q-1}{qk} \geq 0.
\end{align*} 

Also, since $g_i \geq 2$ for $1 \leq i \leq s + t$, we have,
\begin{align*} 
  \frac{g_i-1}{g_i} \geq \frac{1}{2}, \quad \sum_{i=1}^{s} \frac{g_i-1}{g_i} \geq \frac{s}{2} \quad \text{and} \quad \sum_{i=s+1}^{s+t} \frac{g_i-1}{2g_i} \geq \frac{t}{4}.
\end{align*}

Thus we can find a lower bound for (\ref{classeq}) which limits the possible number of conjugacy classes somewhat,
\begin{align*} 1 > \frac{s}{2} + \frac{t}{4}.
\end{align*}

There are only 6 possible different pairs of values which $s$ and $S$ can take: \vspace{3mm}

\begin{center}
\centering
  \begin{tabular}{||c||c|c|c|c|c|c||}
\hline
Case & I & II & III & IV & V & VI \\ [1ex]
\hline\hline
 $s$ & 1 & 1 & 0 & 0 & 0 & 0 \\ [1ex]
\hline
$S$ & 0 & 1 & 0 & 1 & 2 & 3 \\ [1ex]
 \hline
\end{tabular}
\end{center}
\vspace{2mm}

Each case will be examined individually in the next chapter.